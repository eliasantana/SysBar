/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package br.com.bar.view;

import br.com.bar.dao.Backup;
import br.com.bar.dao.Log;
import br.com.bar.model.DadosEmpresa;
import br.com.br.controler.ControlerDadosEmpresa;
import br.com.br.controler.ControlerParametro;
import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.logging.Level;
import java.util.logging.Logger;


/**
 *
 * @author elias
 */
public class TelaPametro extends javax.swing.JFrame {

    ControlerDadosEmpresa empresa = new ControlerDadosEmpresa();
    DadosEmpresa dados = empresa.selecionaDados();
    Log l = new Log();
    public TelaPametro() {
        initComponents();
        
        ControlerParametro parametro = new ControlerParametro();
        
        txtIpServidor.setText(parametro.lerArquivoParametro().get(0));
        txtUsuario.setText(parametro.lerArquivoParametro().get(1));
        txtSenha.setText(parametro.lerArquivoParametro().get(2));
        txtNomeBanco.setText(parametro.lerArquivoParametro().get(3));
        txtPorta.setText(parametro.lerArquivoParametro().get(4));
        
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jLabel2 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        jLabel4 = new javax.swing.JLabel();
        txtIpServidor = new javax.swing.JTextField();
        txtPorta = new javax.swing.JTextField();
        txtNomeBanco = new javax.swing.JTextField();
        txtSenha = new javax.swing.JTextField();
        jLabel5 = new javax.swing.JLabel();
        bnSalvar = new javax.swing.JButton();
        txtUsuario = new javax.swing.JTextField();
        jLabel6 = new javax.swing.JLabel();
        jPanel1 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        jLabel7 = new javax.swing.JLabel();
        jPanel2 = new javax.swing.JPanel();
        lblFechar = new javax.swing.JLabel();
        jLabel8 = new javax.swing.JLabel();
        jPanel3 = new javax.swing.JPanel();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("MasterFood - Parâmetro");
        setBackground(new java.awt.Color(44, 62, 80));
        setUndecorated(true);
        getContentPane().setLayout(null);

        jLabel2.setText("Nome do Banco de Dados:");
        getContentPane().add(jLabel2);
        jLabel2.setBounds(41, 93, 220, 14);

        jLabel3.setText("Porta:");
        getContentPane().add(jLabel3);
        jLabel3.setBounds(201, 204, 110, 14);

        jLabel4.setText("Usuário do Banco:");
        getContentPane().add(jLabel4);
        jLabel4.setBounds(41, 144, 130, 14);
        getContentPane().add(txtIpServidor);
        txtIpServidor.setBounds(41, 224, 126, 30);
        getContentPane().add(txtPorta);
        txtPorta.setBounds(201, 224, 120, 30);
        getContentPane().add(txtNomeBanco);
        txtNomeBanco.setBounds(41, 113, 126, 30);
        getContentPane().add(txtSenha);
        txtSenha.setBounds(201, 164, 120, 30);

        jLabel5.setText("Senha:");
        getContentPane().add(jLabel5);
        jLabel5.setBounds(201, 144, 130, 14);

        bnSalvar.setBackground(new java.awt.Color(30, 139, 195));
        bnSalvar.setForeground(new java.awt.Color(255, 255, 255));
        bnSalvar.setText("Salvar");
        bnSalvar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                bnSalvarActionPerformed(evt);
            }
        });
        getContentPane().add(bnSalvar);
        bnSalvar.setBounds(40, 270, 280, 40);
        getContentPane().add(txtUsuario);
        txtUsuario.setBounds(41, 164, 126, 30);

        jLabel6.setText("IP do Servidor (localhost):");
        getContentPane().add(jLabel6);
        jLabel6.setBounds(41, 204, 160, 14);

        jPanel1.setBackground(new java.awt.Color(243, 156, 18));
        jPanel1.setLayout(null);

        jLabel1.setFont(new java.awt.Font("Yu Gothic UI Light", 0, 36)); // NOI18N
        jLabel1.setForeground(new java.awt.Color(52, 73, 94));
        jLabel1.setText("Banco de Dados");
        jPanel1.add(jLabel1);
        jLabel1.setBounds(50, 12, 247, 48);

        jLabel7.setIcon(new javax.swing.ImageIcon(getClass().getResource("/br/com/bar/imagens/bd.png"))); // NOI18N
        jPanel1.add(jLabel7);
        jLabel7.setBounds(12, 19, 32, 32);

        jPanel2.setBackground(new java.awt.Color(44, 62, 80));

        lblFechar.setFont(new java.awt.Font("Tahoma", 1, 18)); // NOI18N
        lblFechar.setForeground(new java.awt.Color(255, 255, 255));
        lblFechar.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        lblFechar.setIcon(new javax.swing.ImageIcon(getClass().getResource("/br/com/bar/imagens/fecharWhite24x24.png"))); // NOI18N
        lblFechar.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                lblFecharMouseClicked(evt);
            }
        });

        javax.swing.GroupLayout jPanel2Layout = new javax.swing.GroupLayout(jPanel2);
        jPanel2.setLayout(jPanel2Layout);
        jPanel2Layout.setHorizontalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(lblFechar, javax.swing.GroupLayout.DEFAULT_SIZE, 40, Short.MAX_VALUE)
        );
        jPanel2Layout.setVerticalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(lblFechar, javax.swing.GroupLayout.DEFAULT_SIZE, 40, Short.MAX_VALUE)
        );

        jPanel1.add(jPanel2);
        jPanel2.setBounds(330, 0, 40, 40);

        getContentPane().add(jPanel1);
        jPanel1.setBounds(0, 0, 370, 70);

        jLabel8.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jLabel8.setIcon(new javax.swing.ImageIcon(getClass().getResource("/br/com/bar/imagens/btnBackup.png"))); // NOI18N
        jLabel8.setText("Realizar Backup agora!");
        jLabel8.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                jLabel8MouseClicked(evt);
            }
        });
        getContentPane().add(jLabel8);
        jLabel8.setBounds(50, 320, 260, 40);

        jPanel3.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(0, 0, 0)));
        jPanel3.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                jPanel3MouseClicked(evt);
            }
        });

        javax.swing.GroupLayout jPanel3Layout = new javax.swing.GroupLayout(jPanel3);
        jPanel3.setLayout(jPanel3Layout);
        jPanel3Layout.setHorizontalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 366, Short.MAX_VALUE)
        );
        jPanel3Layout.setVerticalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 368, Short.MAX_VALUE)
        );

        getContentPane().add(jPanel3);
        jPanel3.setBounds(0, 5, 368, 370);

        setSize(new java.awt.Dimension(369, 377));
        setLocationRelativeTo(null);
    }// </editor-fold>//GEN-END:initComponents

    private void bnSalvarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_bnSalvarActionPerformed
        ControlerParametro parametro = new ControlerParametro();
        parametro.criarArquivoParametro(txtIpServidor.getText(), txtUsuario.getText(), txtSenha.getText(), txtNomeBanco.getText(), txtPorta.getText());
        System.exit(0);
        
    }//GEN-LAST:event_bnSalvarActionPerformed

    private void lblFecharMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_lblFecharMouseClicked
        // Fecha janela deconfigurações
        this.dispose();
    }//GEN-LAST:event_lblFecharMouseClicked

    private void jLabel8MouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_jLabel8MouseClicked

        //Realiza Backup do Sistema
        // Instancia a classe backup
        Backup bkp = new Backup();
        // Returna true se o backup for realizado com sucesso!
        boolean bkpCriado = bkp.Backup();
        
        if (bkpCriado) {
            System.out.println("Criando Arquivo de Backup!");
            
            try {
                // Inicia a Thread que aguardará 15 segundos 
                Thread.sleep(15000);
                // Localiza o arquivo de backup.
                File f = new File("C:/SysBar/backup/bkpdumpSYSBAR.sql");
                
                // Verifica se o arquivo existe
                if (f.exists()) {
                    // Captura a data e a hora        
                    System.out.println("Preparando o arquivo!...");
                    String formatoData = "ddMMyyy";
                    String formatoHora = "hhmmss";
                    Date data = new Date();
                    SimpleDateFormat df = new SimpleDateFormat(formatoData);
                    SimpleDateFormat hf = new SimpleDateFormat(formatoHora);
                    String dt = df.format(data);
                    String h = hf.format(data);
                    DadosEmpresa dados = new DadosEmpresa();
                    // Carrega dados do cadastro da empresa
                    dados = empresa.selecionaDados();
                    // Renomeia o arquivo concatenando a data e a hora em que o arquivo foi criado.
                    
                    //File f2 = new File("C:/SysBar/backup/bkpdumpSYSBAR" + dt + h + ".sql");
                    File f2 = new File("C:/SysBar/backup/bkp-"+dados.getNome_empresa()+"-" + dt +"-"+ h + ".sql");
                   
                    // Retor na verdadeiro se o arquivo for renomeado com sucesso.
                    boolean resp = f.renameTo(f2); 
                    
                    if (resp) {
                        System.out.println("Bakup finalizado com sucesso!"); 
                        String destino = dados.getUrlbackup()+"\\"+f2.getName();
                        // Copiar o arquivo de backup para o local de bakup selecionado no cadastro.
                        copyBakup(f2.getAbsolutePath(), destino);
                        
                    } else {
                        System.out.println("Falha ao renomear o arquivo de backup");

                    }
                } else {
                    System.out.println("Arquivo não Existe");

                }
            } catch (InterruptedException e) {
                System.out.println("Erro na Thread!");
            }
        }


    }//GEN-LAST:event_jLabel8MouseClicked

    private void jPanel3MouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_jPanel3MouseClicked
        // TODO add your handling code here:
    }//GEN-LAST:event_jPanel3MouseClicked
    public void copyBakup(String origem, String destino){
         //System.out.println("Backup copiado de->" + origem + " para " + destino);
         Path pathOrigem = Paths.get(origem);
         Path pathDestino = Paths.get(destino);
         System.out.println(pathDestino.toString());
         System.out.println(pathOrigem.toString());
         
        try {
            Files.copy(pathOrigem, pathDestino);
            System.out.println("Backup copiado com sucesso!");
        } catch (IOException ex) {
            Logger.getLogger(TelaPametro.class.getName()).log(Level.SEVERE, null, ex);
            System.out.println("br.com.bar.view.TelaPametro.copyBakup()");
        }
    }
    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        /* Set the Nimbus look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
         * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
         */
        try {
            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                if ("Nimbus".equals(info.getName())) {
                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (ClassNotFoundException ex) {
            java.util.logging.Logger.getLogger(TelaPametro.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (InstantiationException ex) {
            java.util.logging.Logger.getLogger(TelaPametro.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (IllegalAccessException ex) {
            java.util.logging.Logger.getLogger(TelaPametro.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (javax.swing.UnsupportedLookAndFeelException ex) {
            java.util.logging.Logger.getLogger(TelaPametro.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        }
        //</editor-fold>
        //</editor-fold>

        /* Create and display the form */
        java.awt.EventQueue.invokeLater(new Runnable() {
            public void run() {
                new TelaPametro().setVisible(true);
            }
        });
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton bnSalvar;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JLabel jLabel7;
    private javax.swing.JLabel jLabel8;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JLabel lblFechar;
    private javax.swing.JTextField txtIpServidor;
    private javax.swing.JTextField txtNomeBanco;
    private javax.swing.JTextField txtPorta;
    private javax.swing.JTextField txtSenha;
    private javax.swing.JTextField txtUsuario;
    // End of variables declaration//GEN-END:variables
}
